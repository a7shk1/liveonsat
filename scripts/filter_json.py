# scripts/filter_json.py
# -*- coding: utf-8 -*-
import json
import re
import unicodedata
from pathlib import Path
import requests
import os

# ===== ุชุฑุฌูุฉ ุงุฎุชูุงุฑูุฉ (fallback) =====
try:
    from deep_translator import GoogleTranslator
except Exception:
    GoogleTranslator = None

# ===== ุฅุนุฏุงุฏุงุช =====
REPO_ROOT = Path(__file__).resolve().parents[1]
MATCHES_DIR = REPO_ROOT / "matches"
INPUT_PATH = MATCHES_DIR / "liveonsat_raw.json"        # ููููู ููู ุงููููุงุช
OUTPUT_PATH = MATCHES_DIR / "filtered_matches.json"
YALLASHOOT_URL = "https://raw.githubusercontent.com/a7shk1/yallashoot/refs/heads/main/matches/today.json"

# ===== ุฃุฏูุงุช ุนุงูุฉ =====
AR_LETTERS_RE = re.compile(r'[\u0600-\u06FF]')
EMOJI_MISC_RE = re.compile(r'[\u2600-\u27BF\U0001F300-\U0001FAFF]+')
BEIN_RE = re.compile(r'bein\s*sports?', re.I)

def strip_accents(s: str) -> str:
    return ''.join(c for c in unicodedata.normalize("NFKD", s) if not unicodedata.combining(c))

def normalize_text(text: str) -> str:
    if not text:
        return ""
    text = str(text)
    text = EMOJI_MISC_RE.sub("", text)
    text = re.sub(r"\(.*?\)", "", text)
    text = strip_accents(text)
    text = text.lower()
    text = text.replace("&", "and")
    text = re.sub(r"\b(fc|sc|cf|u\d+)\b", "", text)  # ุดูู ูุงุญูุงุช ุดุงุฆุนุฉ
    text = text.replace("ุงู", "")
    # ุจุฏุงุฆู ุนุฑุจูุฉ ุดุงุฆุนุฉ
    text = text.replace("ู", "ู").replace("ุฉ", "ู").replace("ุฃ", "ุง").replace("ุฅ", "ุง").replace("ุข", "ุง")
    text = text.replace("ู", "")  # ุชุทููู
    text = text.replace(" ", "").replace("-", "").replace("_", "")
    text = re.sub(r"[^a-z0-9\u0600-\u06FF]", "", text)
    return text.strip()

def unique_preserving(seq):
    seen, out = set(), []
    for x in seq:
        k = str(x).lower().strip()
        if k not in seen:
            seen.add(k)
            out.append(x)
    return out

def to_list_channels(val):
    if isinstance(val, list):
        return [str(x).strip() for x in val if str(x).strip()]
    if isinstance(val, str):
        s = val.strip()
        if not s: return []
        parts = re.split(r"\s*(?:,|ุ|/|\||&| ู | and )\s*", s, flags=re.I)
        return [p for p in parts if p]
    return []

def clean_channel_display(name: str) -> str:
    if not name: return ""
    s = str(name)
    s = EMOJI_MISC_RE.sub("", s)
    s = re.sub(r"\s*\((?:\$?\/?geo\/?R|geo\/?R|\$\/?geo)\)\s*", "", s, flags=re.I)
    s = re.sub(r"๐บ|\[online\]|\[app\]", "", s, flags=re.I)
    s = re.sub(r"\s+", " ", s).strip()
    return s

def is_bein_channel(name: str) -> bool:
    return bool(BEIN_RE.search(name or ""))

# ===== ุงููููุงุช ุงููุฏุนููุฉ (ููุชุฑุฉ ุตุงุฑูุฉ) =====
SUPPORTED_CHANNELS = [
    "MATCH! Futbol 1", "MATCH! Futbol 2", "MATCH! Futbol 3",
    "Football HD",
    "Sport TV1 Portugal HD", "Sport TV2 Portugal HD",
    "ESPN 1 Brazil", "ESPN 2 Brazil", "ESPN 3 Brazil", "ESPN 4 Brazil", "ESPN 5 Brazil", "ESPN 6 Brazil", "ESPN 7 Brazil",
    "DAZN 1 Portugal HD", "DAZN 2 Portugal HD", "DAZN 3 Portugal HD", "DAZN 4 Portugal HD", "DAZN 5 Portugal HD", "DAZN 6 Portugal HD",
    "MATCH! Premier HD", "Sky Sports Main Event HD", "Sky Sport Premier League HD", "IRIB Varzesh HD",
    "Persiana Sport HD", "MBC Action HD", "TNT Sports 1 HD", "TNT Sports 2 HD", "TNT Sports HD",
    "MBC masrHD", "MBC masr2HD", "ssc1 hd", "ssc2 hd", "Shahid MBC",
]
_supported_tokens = set()
for c in SUPPORTED_CHANNELS:
    cl = c.lower()
    _supported_tokens.add(cl)
    _supported_tokens.add(cl.replace(" hd", ""))
SUPPORTED_TOKENS = list(_supported_tokens)

def is_supported_channel(name: str) -> bool:
    if not name: return False
    n = name.lower()
    return any(tok in n for tok in SUPPORTED_TOKENS)

# =====================================================================
# ูุงููุณ ุถุฎู ูุฏูู (ุฃูุฏูุฉ ุนุฑุจูุฉ + ุฃูุฑูุจูุฉ + ููุชุฎุจุงุช) โ ููุณูุน ููุบุงูุฉ
# ููุงุญุธุฉ: ุชูุฏุฑ ุชุถูู ูู ูุงุญููุง ุจุญุฑูุฉุ ุงูุณูุฑุจุช ูุณุชุฎุฏูู ุฃูููุง ูุจู ุฃู ุชุฑุฌูุฉ
# =====================================================================

EN2AR = {
    # ----- ููุชุฎุจุงุช ุนุฑุจูุฉ -----
    "Iraq": "ุงูุนุฑุงู", "Saudi Arabia": "ุงูุณุนูุฏูุฉ", "Qatar": "ูุทุฑ", "United Arab Emirates": "ุงูุฅูุงุฑุงุช",
    "UAE": "ุงูุฅูุงุฑุงุช", "Kuwait": "ุงููููุช", "Bahrain": "ุงูุจุญุฑูู", "Oman": "ุนููุงู", "Jordan": "ุงูุฃุฑุฏู",
    "Syria": "ุณูุฑูุง", "Lebanon": "ูุจูุงู", "Palestine": "ููุณุทูู", "Yemen": "ุงูููู", "Egypt": "ูุตุฑ",
    "Libya": "ููุจูุง", "Tunisia": "ุชููุณ", "Algeria": "ุงูุฌุฒุงุฆุฑ", "Morocco": "ุงููุบุฑุจ",
    "Somalia": "ุงูุตููุงู", "Sudan": "ุงูุณูุฏุงู", "Mauritania": "ููุฑูุชุงููุง",

    # ----- ููุชุฎุจุงุช ุนุงูููุฉ ูุดููุฑุฉ -----
    "Brazil": "ุงูุจุฑุงุฒูู", "Argentina": "ุงูุฃุฑุฌูุชูู", "Germany": "ุฃููุงููุง", "France": "ูุฑูุณุง",
    "Spain": "ุฅุณุจุงููุง", "Italy": "ุฅูุทุงููุง", "England": "ุฅูุฌูุชุฑุง", "Portugal": "ุงูุจุฑุชุบุงู",
    "Netherlands": "ููููุฏุง", "Belgium": "ุจูุฌููุง", "Croatia": "ูุฑูุงุชูุง", "Uruguay": "ุฃูุฑูุฌูุงู",
    "USA": "ุงูููุงูุงุช ุงููุชุญุฏุฉ", "United States": "ุงูููุงูุงุช ุงููุชุญุฏุฉ", "Mexico": "ุงูููุณูู",
    "Japan": "ุงููุงุจุงู", "South Korea": "ููุฑูุง ุงูุฌููุจูุฉ", "Australia": "ุฃุณุชุฑุงููุง",

    # ----- ุฃูุฏูุฉ ุณุนูุฏูุฉ -----
    "Al Hilal": "ุงูููุงู", "Al-Hilal": "ุงูููุงู",
    "Al Nassr": "ุงููุตุฑ", "Al-Nassr": "ุงููุตุฑ",
    "Al Ittihad": "ุงูุงุชุญุงุฏ", "Al-Ittihad": "ุงูุงุชุญุงุฏ",
    "Al Ahli": "ุงูุฃููู ุงูุณุนูุฏู", "Al-Ahli": "ุงูุฃููู ุงูุณุนูุฏู",
    "Al Shabab": "ุงูุดุจุงุจ", "Al-Shabab": "ุงูุดุจุงุจ",
    "Al Ettifaq": "ุงูุงุชูุงู", "Al-Ettifaq": "ุงูุงุชูุงู",
    "Al Fayha": "ุงูููุญุงุก", "Al-Fayha": "ุงูููุญุงุก",
    "Al Raed": "ุงูุฑุงุฆุฏ", "Al-Raed": "ุงูุฑุงุฆุฏ",
    "Al Taawoun": "ุงูุชุนุงูู", "Al-Taawoun": "ุงูุชุนุงูู",
    "Abha": "ุฃุจูุง", "Damac": "ุถูู", "Al Fateh": "ุงููุชุญ", "Al-Fateh": "ุงููุชุญ",
    "Al Okhdood": "ุงูุฃุฎุฏูุฏ", "Al-Okhdood": "ุงูุฃุฎุฏูุฏ",
    "Al Riyadh": "ุงูุฑูุงุถ", "Al-Riyadh": "ุงูุฑูุงุถ",
    "Al Wehda": "ุงููุญุฏุฉ", "Al-Wehda": "ุงููุญุฏุฉ",
    "Al Qadsiah": "ุงููุงุฏุณูุฉ", "Al-Qadsiah": "ุงููุงุฏุณูุฉ",

    # ----- ุฃูุฏูุฉ ูุทุฑ -----
    "Al Sadd": "ุงูุณุฏ", "Al-Sadd": "ุงูุณุฏ",
    "Al Duhail": "ุงูุฏุญูู", "Al-Duhail": "ุงูุฏุญูู",
    "Al Gharafa": "ุงูุบุฑุงูุฉ", "Al-Gharafa": "ุงูุบุฑุงูุฉ",
    "Al Rayyan": "ุงูุฑูุงู", "Al-Rayyan": "ุงูุฑูุงู",
    "Qatar SC": "ูุทุฑ", "Al Arabi": "ุงูุนุฑุจู", "Al-Arabi": "ุงูุนุฑุจู",
    "Al Wakrah": "ุงูููุฑุฉ", "Al-Wakrah": "ุงูููุฑุฉ",

    # ----- ุฃูุฏูุฉ ุงูุฅูุงุฑุงุช -----
    "Al Ain": "ุงูุนูู", "Al-Ain": "ุงูุนูู",
    "Al Wahda": "ุงููุญุฏุฉ", "Al-Wahda": "ุงููุญุฏุฉ",
    "Al Jazira": "ุงูุฌุฒูุฑุฉ", "Al-Jazira": "ุงูุฌุฒูุฑุฉ",
    "Shabab Al Ahli": "ุดุจุงุจ ุงูุฃููู", "Al Nasr Dubai": "ุงููุตุฑ ุงูุฅูุงุฑุงุชู",
    "Sharjah": "ุงูุดุงุฑูุฉ", "Khor Fakkan": "ุฎูุฑููุงู", "Bani Yas": "ุจูู ูุงุณ",

    # ----- ุฃูุฏูุฉ ุงูุนุฑุงู -----
    "Al Shorta": "ุงูุดุฑุทุฉ", "Al-Shorta": "ุงูุดุฑุทุฉ",
    "Al Zawraa": "ุงูุฒูุฑุงุก", "Al-Zawraa": "ุงูุฒูุฑุงุก",
    "Al Quwa Al Jawiya": "ุงูููุฉ ุงูุฌููุฉ", "Al-Quwa Al-Jawiya": "ุงูููุฉ ุงูุฌููุฉ",
    "Naft Al Wasat": "ููุท ุงููุณุท", "Al Najaf": "ุงููุฌู",
    "Karbalaa": "ูุฑุจูุงุก", "Duhok": "ุฏููู", "Erbil": "ุฃุฑุจูู", "Al Mina'a": "ุงููููุงุก", "Al-Minaa": "ุงููููุงุก",

    # ----- ุฃูุฏูุฉ ุงููุบุฑุจ -----
    "Wydad": "ุงููุฏุงุฏ", "Raja": "ุงูุฑุฌุงุก", "FUS Rabat": "ุงููุชุญ ุงูุฑุจุงุทู",
    "RS Berkane": "ููุถุฉ ุจุฑูุงู", "Hassania Agadir": "ุญุณููุฉ ุฃูุงุฏูุฑ",
    "Ittihad Tanger": "ุงุชุญุงุฏ ุทูุฌุฉ", "OC Safi": "ุฃูููุจูู ุขุณูู", "Olympic Safi": "ุฃูููุจูู ุขุณูู",

    # ----- ุฃูุฏูุฉ ุชููุณ -----
    "Esperance": "ุงูุชุฑุฌู", "Etoile du Sahel": "ุงููุฌู ุงูุณุงุญูู",
    "Club Africain": "ุงููุงุฏู ุงูุฅูุฑููู", "CS Sfaxien": "ุงูุตูุงูุณู",

    # ----- ุฃูุฏูุฉ ุงูุฌุฒุงุฆุฑ -----
    "USM Alger": "ุงุชุญุงุฏ ุงูุนุงุตูุฉ", "JS Kabylie": "ุดุจูุจุฉ ุงููุจุงุฆู",
    "MC Alger": "ููููุฏูุฉ ุงูุฌุฒุงุฆุฑ",

    # ----- ุฃูุฏูุฉ ูุตุฑ -----
    "Al Ahly": "ุงูุฃููู", "Zamalek": "ุงูุฒูุงูู", "Pyramids": "ุจูุฑุงููุฏุฒ",
    "Ismaily": "ุงูุฅุณูุงุนููู", "Al Masry": "ุงููุตุฑู", "Smouha": "ุณููุญุฉ",

    # ----- ุฃูุฏูุฉ ุงูุฃุฑุฏู/ุณูุฑูุง/ูุจูุงู -----
    "Al Faisaly": "ุงูููุตูู", "Al Wehdat": "ุงููุญุฏุงุช",
    "Al Jazeera Amman": "ุงูุฌุฒูุฑุฉ (ุงูุฃุฑุฏู)", "Shabab Al Ordon": "ุดุจุงุจ ุงูุฃุฑุฏู",
    "Al Jaish": "ุงูุฌูุด", "Al Karamah": "ุงููุฑุงูุฉ",
    "Al Ahed": "ุงูุนูุฏ", "Al Nejmeh": "ุงููุฌูุฉ",

    # ----- ุฃูุฏูุฉ ุฃูุฑูุจูุฉ ูุจูุฑุฉ -----
    "Real Madrid": "ุฑูุงู ูุฏุฑูุฏ", "Barcelona": "ุจุฑุดูููุฉ", "Atletico Madrid": "ุฃุชูุชููู ูุฏุฑูุฏ",
    "Sevilla": "ุฅุดุจูููุฉ", "Valencia": "ูุงููุณูุง", "Villarreal": "ููุงุฑูุงู", "Real Sociedad": "ุฑูุงู ุณูุณูุฏุงุฏ",
    "Espanyol": "ุฅุณุจุงูููู", "Real Mallorca": "ุฑูุงู ูุงููุฑูุง", "Mallorca": "ุฑูุงู ูุงููุฑูุง",
    "Bayern Munich": "ุจุงูุฑู ููููุฎ", "Borussia Dortmund": "ุจูุฑูุณูุง ุฏูุฑุชูููุฏ",
    "RB Leipzig": "ูุงูุจุฒูุบ", "Bayer Leverkusen": "ุจุงูุฑ ูููุฑููุฒู",
    "Inter": "ุฅูุชุฑ ูููุงู", "Inter Milan": "ุฅูุชุฑ ูููุงู",
    "AC Milan": "ูููุงู", "Milan": "ูููุงู", "Juventus": "ููููุชูุณ", "Napoli": "ูุงุจููู", "Roma": "ุฑููุง", "Lazio": "ูุงุชุณูู", "Fiorentina": "ูููุฑูุชููุง", "Atalanta": "ุฃุชุงูุงูุชุง", "Torino": "ุชูุฑููู", "Udinese": "ุฃูุฏูููุฒู", "Sassuolo": "ุณุงุณููู", "Monza": "ูููุฒุง", "Como": "ูููู", "Genoa": "ุฌููู", "Hellas Verona": "ูููุงุณ ููุฑููุง", "Cremonese": "ูุฑูููููุฒู",
    "Paris Saint-Germain": "ุจุงุฑูุณ ุณุงู ุฌูุฑูุงู", "PSG": "ุจุงุฑูุณ ุณุงู ุฌูุฑูุงู",
    "Marseille": "ูุงุฑุณูููุง", "Lyon": "ูููู", "Monaco": "ูููุงูู", "Lille": "ููู", "Nice": "ููุณ", "Rennes": "ุฑูู", "Brest": "ุจุฑูุณุช", "Strasbourg": "ุณุชุฑุงุณุจูุฑุบ", "Montpellier": "ูููุจูููู", "Guingamp": "ุฌุงูุฌูู",
    "Manchester City": "ูุงูุดุณุชุฑ ุณูุชู", "Manchester United": "ูุงูุดุณุชุฑ ูููุงูุชุฏ", "Arsenal": "ุฃุฑุณูุงู", "Liverpool": "ูููุฑุจูู",
    "Chelsea": "ุชุดููุณู", "Tottenham Hotspur": "ุชูุชููุงู", "Tottenham": "ุชูุชููุงู", "Newcastle United": "ููููุงุณู ูููุงูุชุฏ", "Aston Villa": "ุฃุณุชูู ูููุง", "Everton": "ุฅููุฑุชูู", "West Ham United": "ูุณุช ูุงู ูููุงูุชุฏ", "Wolves": "ูููุฑูุงูุจุชูู", "Wolverhampton": "ูููุฑูุงูุจุชูู",
    "Ajax": "ุฃูุงูุณ", "PSV Eindhoven": "ุขููุฏูููู", "Feyenoord": "ูุงูููุฑุฏ",
    "Benfica": "ุจููููุง", "Porto": "ุจูุฑุชู", "Sporting CP": "ุณุจูุฑุชููุบ ูุดุจููุฉ", "Sporting": "ุณุจูุฑุชููุบ ูุดุจููุฉ",
}

# ุนูุณ ุงููุงููุณ
AR2EN = {v: k for k, v in EN2AR.items()}

def translate_en_to_ar(name: str) -> str:
    if not name: return ""
    if name in EN2AR: return EN2AR[name]
    if GoogleTranslator:
        try:
            return (GoogleTranslator(source="en", target="ar").translate(name) or name).strip()
        except Exception:
            return name
    return name

def translate_ar_to_en(name: str) -> str:
    if not name: return ""
    if name in AR2EN: return AR2EN[name]
    if GoogleTranslator:
        try:
            return (GoogleTranslator(source="ar", target="en").translate(name) or name).strip()
        except Exception:
            return name
    return name

# ===== parsing =====
def parse_title_to_teams_generic(title: str) -> tuple[str | None, str | None]:
    if not title:
        return None, None
    t = title.strip()
    DELIMS = [
        r"\s+v(?:s)?\.?\s+",
        r"\s+-\s+", r"\s+โ\s+", r"\s+โ\s+",
        r"\s*:\s*", r"\s*\|\s*", r"\s*ยท\s*", r"\s*;\s*",
    ]
    for d in DELIMS:
        parts = re.split(d, t, maxsplit=1)
        if len(parts) == 2:
            left, right = parts[0].strip(), parts[1].strip()
            if left and right:
                return left, right
    return None, None

def extract_liveonsat_match_teams(m: dict) -> tuple[str | None, str | None]:
    home = (m.get("home") or m.get("home_team"))
    away = (m.get("away") or m.get("away_team"))
    if home and away:
        return str(home).strip(), str(away).strip()
    title = (m.get("title") or "").strip()
    return parse_title_to_teams_generic(title)

# ===== ุจูุงุก liveonsat entries ุจุงููููุงุช ุงููุณููุญุฉ ููุท =====
def build_liveonsat_entries(live_data: dict):
    entries = []
    matches = (live_data or {}).get("matches", []) or []
    for m in matches:
        h_en, a_en = extract_liveonsat_match_teams(m)
        if not h_en or not a_en:
            continue

        # ูููุงุช ูู ุนุฏุฉ ุญููู
        raw_channels = []
        for ck in ("channels_raw","channels","tv_channels","broadcasters","broadcaster"):
            if ck in m and m[ck]:
                raw = m[ck]
                if isinstance(raw, list):
                    raw_channels.extend([str(x) for x in raw])
                elif isinstance(raw, str):
                    raw_channels.extend(to_list_channels(raw))

        filtered = []
        for ch in raw_channels:
            ch = clean_channel_display(ch)
            if not ch: continue
            if is_bein_channel(ch):  # beIN ูู ููุง ููุท
                continue
            if is_supported_channel(ch):
                filtered.append(ch)
        filtered = unique_preserving(filtered)
        if filtered:
            entries.append({
                "home_en": str(h_en).strip(),
                "away_en": str(a_en).strip(),
                "home_ar": translate_en_to_ar(str(h_en).strip()),
                "away_ar": translate_en_to_ar(str(a_en).strip()),
                "channels": filtered
            })
    return entries

# ===== ุงููุทุงุจูุฉ ุงูุตุงุฑูุฉ ุจุนุฏ ุงูุชุฑุฌูุฉ =====
def equal_norm(a: str, b: str) -> bool:
    return normalize_text(a) == normalize_text(b)

def match_channels_strict(home_ar_y: str, away_ar_y: str, lons_entries: list) -> list:
    """
    ูุทุงุจู ุตุงุฑููุง ุจุงุณุชุฎุฏุงู ุงูุชุฑุฌูุฉ:
      - ููุงุฑู:
        1) AR_yalla == (EN_live โ AR)  ููู ูู home/away (ูุงูุนูุณ ุจุงูุชุฑุชูุจ)
        2) (AR_yalla โ EN) == EN_live   ููู ูู home/away (ูุงูุนูุณ ุจุงูุชุฑุชูุจ)
    ุฃู ุชุทุงุจู ูุงูู ูููุจู.
    """
    if not home_ar_y or not away_ar_y:
        return []

    # ุชุฑุฌูุงุช yalla->EN ูุฑูุฉ ูุญุฏุฉ
    home_en_y = translate_ar_to_en(home_ar_y)
    away_en_y = translate_ar_to_en(away_ar_y)

    out = []
    for e in lons_entries:
        h_en = e["home_en"]; a_en = e["away_en"]
        h_ar = e["home_ar"]; a_ar = e["away_ar"]

        # ุดุฑุท A: ูุงุฑู ุนุฑุจู ูุนุฑุจู (EN_live ูุชุฑุฌู ููุนุฑุจู)
        a_ok = equal_norm(home_ar_y, h_ar) and equal_norm(away_ar_y, a_ar)
        b_ok = equal_norm(home_ar_y, a_ar) and equal_norm(away_ar_y, h_ar)

        # ุดุฑุท B: ูุงุฑู ุฅูุฌููุฒู ูุฅูุฌููุฒู (yalla ูุชุฑุฌู ููุฅูุฌููุฒู)
        c_ok = equal_norm(home_en_y, h_en) and equal_norm(away_en_y, a_en)
        d_ok = equal_norm(home_en_y, a_en) and equal_norm(away_en_y, h_en)

        if a_ok or b_ok or c_ok or d_ok:
            out.extend(e["channels"])

    return unique_preserving(out)

# ===== ูููุงุช ููุง ุดูุช =====
def collect_yalla_channels(yalla_match: dict) -> list:
    keys_try = ["channels_raw","channels","tv_channels","channel","channel_ar","channel_en","broadcasters","broadcaster"]
    out = []
    for k in keys_try:
        if k in yalla_match:
            out.extend(to_list_channels(yalla_match.get(k)))
    return unique_preserving(out)

def pick_primary_yalla_channel(chs: list[str]) -> str | None:
    if not chs:
        return None
    for c in chs:
        if is_bein_channel(c):
            return c.strip()
    return chs[0].strip()

# ===== ุงูุฑุฆูุณู =====
def filter_matches():
    # 1) ููุง ุดูุช
    try:
        yresp = requests.get(YALLASHOOT_URL, timeout=25)
        yresp.raise_for_status()
        yalla = yresp.json()
    except Exception as e:
        print(f"[x] ERROR fetching yallashoot: {e}")
        return

    yalla_matches = (yalla or {}).get("matches", []) or []
    if not yalla_matches:
        print("[!] yallashoot empty.")
        with OUTPUT_PATH.open("w", encoding="utf-8") as f:
            json.dump({"date": yalla.get("date"), "source_url": YALLASHOOT_URL, "matches": []}, f, ensure_ascii=False, indent=2)
        return

    # 2) liveonsat ูุญูู
    try:
        with INPUT_PATH.open("r", encoding="utf-8") as f:
            live_data = json.load(f)
    except Exception as e:
        print(f"[!] WARNING reading liveonsat: {e}")
        live_data = {}

    lons_entries = build_liveonsat_entries(live_data)

    # 3) ุฏูุฌ
    out_matches = []
    used_extra = 0
    for m in yalla_matches:
        home_ar = (m.get("home") or m.get("home_team") or "").strip()
        away_ar = (m.get("away") or m.get("away_team") or "").strip()
        if not home_ar or not away_ar:
            continue

        # ููุงุฉ ุฃุณุงุณูุฉ ูู ููุง
        y_chs = collect_yalla_channels(m)
        primary = pick_primary_yalla_channel(y_chs)
        yalla_only = [primary] if primary else []

        # ูููุงุช ุฅุถุงููุฉ ูู liveonsat ุนุจุฑ ูุทุงุจูุฉ ุตุงุฑูุฉ ุจุนุฏ ุงูุชุฑุฌูุฉ
        extra = match_channels_strict(home_ar, away_ar, lons_entries)
        if extra:
            used_extra += 1

        channels = unique_preserving([*yalla_only, *extra])

        new_entry = {
            "competition": m.get("competition") or m.get("league") or m.get("tournament"),
            "kickoff_baghdad": m.get("kickoff_baghdad") or m.get("time_baghdad") or m.get("kickoff"),
            "home_team": home_ar,
            "away_team": away_ar,
            "channels_raw": channels,
            "home_logo": m.get("home_logo"),
            "away_logo": m.get("away_logo"),
            "status_text": m.get("status_text"),
            "result_text": m.get("result_text"),
        }
        out_matches.append(new_entry)

    with OUTPUT_PATH.open("w", encoding="utf-8") as f:
        json.dump({"date": yalla.get("date"), "source_url": YALLASHOOT_URL, "matches": out_matches}, f, ensure_ascii=False, indent=2)

    print(f"[โ] Done. Matches: {len(out_matches)} | Added-extra-from-liveonsat: {used_extra}")
    if GoogleTranslator is None:
        print("[!] deep-translator not installed โ fallback to dictionary only.")

if __name__ == "__main__":
    filter_matches()
